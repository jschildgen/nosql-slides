<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>NoSQL-Datenbanken - Kapitel 3 - Performance</title>

		<link rel="stylesheet" href="reveal.js/dist/reset.css">
		<link rel="stylesheet" href="reveal.js/dist/reveal.css">

        <link rel="stylesheet" href="src/slides.css">
        <link rel="stylesheet" href="src/sql.css">

		<link rel="stylesheet" href="src/layout.css">
        <link rel="stylesheet" href="lib/joint.min.css" />
        <link rel="stylesheet" href="src/erd.css" />
        <link rel="stylesheet" href="src/poll.css" />

		<!-- Theme used for syntax highlighting of code -->
		<script>
			if(window.location.search.match( /print-pdf/gi )) {
				document.getElementsByTagName("head")[0].innerHTML += '<link rel="stylesheet" href="src/routeros.css">';
			} else {
				document.getElementsByTagName("head")[0].innerHTML += '<link rel="stylesheet" href="src/rainbow.css">';
			}
		</script>

        <!--<script defer src="lib/fontawesome.all.min.js"/>-->
        <link href="lib/fontawesome.all.min.css" rel="stylesheet">
        <style> .reveal i.fa { font-family:FontAwesome; font-style: normal; } </style>
	</head>
	<body>
		<div class="reveal">
            <div id="header"></div>
            <div id="footer"></div>
			<div class="slides">
                <section>
                    <h4 style="text-align:center"><b>Prof. Dr.-Ing. Johannes Schildgen</b><br>
                    <a href="mailto:johannes.schildgen@oth-regensburg.de">johannes.schildgen@oth-regensburg.de</a></h4>
                    <h2>NoSQL-Datenbanken</h2>
                    <h4 style="text-align:center">&nbsp;</h4>
                    <h3>Kapitel 3: Performance<br><small>Anfragepläne, Indexe, Monitoring, Profiling</small></h3>
                    <h4 style="text-align:center">&nbsp;<br>&nbsp;</h4>
                    <img src="img/ccby.png" height="60px" style="position: absolute; left:0px; border:0; bottom:-120px;">
                    <img src="img/oth.png" height="60px" style="position: absolute; right:0px; border:0; bottom:-120px; box-shadow:none">
                </section>
                
								<section>
									<h3>Anfragepläne</h3>
									<p class="small">Eingabe: Query</p>
									<pre style="margin-top: -3mm;"><code class="javascript">db.produkte.find({"preis": { "$lt": NumberDecimal("1") }})</code></pre>
									
									<p class="small">1. Anfragepläne generieren</p>
									<div class="columns">
										<div style="text-align: center; font-size: 50%;"><i class="fas fa-scroll red" style="font-size:400%;"></i><br>Plan A</div>
										<div style="text-align: center; font-size: 50%;"><i class="fas fa-scroll green" style="font-size:400%;"></i><br>Plan B</div>
										<div style="text-align: center; font-size: 50%;"><i class="fas fa-scroll blue" style="font-size:400%;"></i><br>Plan C</div>
									</div>

									<p class="small">2. Besten Plan auswählen</p>
									<div class="columns">
										<div style="text-align: center; font-size: 50%;"><i class="fas fa-scroll blue" style="font-size:400%;"></i><br>Plan C</div>
									</div>

									<p class="small">3. Plan ausführen</p>

									<aside class="notes">Bei jeder eingehenden Anfrage erstellt MongoDB Anfragepläne, die beschreiben, wie die Anfrage beantwortet werden kann. Letztendlich wird sich für einen Plan entschieden – den Winning Plan – und dieser wird ausgeführt.​</aside>
								</section>

								<section>
									<h3><code>explain</code></h3>
                                    <div style="position: absolute; top: 1px; right:50px; font-size:80px"><i class="fas fa-scroll green"></i></div>
									<pre style="width: 99%;"><code class="javascript">db.produkte.explain().find({"preis": { "$lt": NumberDecimal("1") }})</code></pre>
									<pre><code class="javascript" style="max-height: 45cm;">{
"queryPlanner" : {
 "namespace" : "webshop.produkte",
// ...
 "winningPlan" : {
  "stage" : "COLLSCAN",
  "filter" : {
    "preis" : {
      "$lt" : NumberDecimal("1")
    }
  },
  "direction" : "forward"
},
"rejectedPlans" : [ ],
// ...
"ok" : 1
}</code></pre>
<aside class="notes"><code>db.produkte.find(...).explain()</code> funktioniert ebenfalls (<code>cursor.explain()</code>). <code>db.collection.explain()</code> liefert ein sogenanntes <em>explainable Object</em></code>. Dieses zeigt den winning Plan für eine Anfrage. Der hier gezeigte Plan führt einen Collection-Scan aus.</aside>
								</section>

<section>
	<h3>Ausführungsstatistiken</h3>
	<p class="small"><code>explain()</code> führt die Anfrage nicht wirklich aus,<br><code>explain("executionStats")​</code> schon.</p>
	<pre style="width: 99%;"><code class="javascript">db.produkte.explain("executionStats")
.find({"preis": { "$lt": NumberDecimal("1") }})</code></pre>
<pre><code class="javascript">{
// ...
"executionStats" : {
 "executionSuccess" : true,
 "nReturned" : 99,
 "executionTimeMillis" : 79,
 "totalKeysExamined" : 0,
 "totalDocsExamined" : 100000,
 "executionStages" : {
  "stage" : "COLLSCAN",
  // ...
 }
}</code></pre>
<aside class="notes">Wird die Option "executionStats" übergeben, beinhaltet der Explain-Plan auch Statistiken über die Ausführung: Wie viele Dokumente kommen bei jedem einzelnen Schritt raus, werden angeschaut, wie viele Millisekunden dauert es, etc. Diese Werte hängen von den tatsächlichen Daten ab während das normale <code>explain()</code> die Daten gar nicht anschaut. Zum Sammeln der Ausführungsstatistiken wird die Anfrage ausgeführt und dabei die Zahlen gesammelt. Die Statistiken oben betreffen den ganzen Plan, also z.B. die Gesamtlaufzeit der Anfrage. In <code>executionStages</code> stehen die gleichen (und weitere) Statistiken für die einzelnen Abschnitte der Anfrage. </aside>
</section>

<section>
	<h3><code>COLLSCAN</code> - Collection Scan</h3>
	<p class="small">Prüfe Dokument für Dokument ob der Preis kleiner als 1 EUR ist:</p>
	<div data-badge="nein" data-badge-position="tr"><pre style="width: 99%;"><code class="javascript">{ "_id": 1, "bezeichnung": "...", "preis": NumberDecimal("1.89")</code></pre></div>
	<div data-badge="nein" data-badge-position="tr"><pre style="width: 99%;"><code class="javascript">{ "_id": 2, "bezeichnung": "...", "preis": NumberDecimal("2.17")</code></pre></div>
	<div data-badge="nein" data-badge-position="tr"><pre style="width: 99%;"><code class="javascript">{ "_id": 3, "bezeichnung": "...", "preis": NumberDecimal("2.22")</code></pre></div>
	<div data-badge="nein" data-badge-position="tr"><pre style="width: 99%;"><code class="javascript">{ "_id": 4, "bezeichnung": "...", "preis": NumberDecimal("5.55")</code></pre></div>
	<div data-badge="nein" data-badge-position="tr"><pre style="width: 99%;"><code class="javascript">{ "_id": 5, "bezeichnung": "...", "preis": NumberDecimal("8.95")</code></pre></div>
	<div data-badge="ja" data-badge-position="tr"><pre style="width: 99%;"><code class="javascript">{ "_id": 6, "bezeichnung": "...", "preis": NumberDecimal("0.89")</code></pre></div>
	<div data-badge="nein" data-badge-position="tr"><pre style="width: 99%;"><code class="javascript">{ "_id": 7, "bezeichnung": "...", "preis": NumberDecimal("1.79")</code></pre></div>
	<div data-badge="ja" data-badge-position="tr"><pre style="width: 99%;"><code class="javascript">{ "_id": 8, "bezeichnung": "...", "preis": NumberDecimal("0.50")</code></pre></div>
	<aside class="notes">Ein Full Collection Scan kann sehr teuer sein, da alle Dokumente einer Collection angeschaut werden müssen.​ In relationalen Datenbanken lautet der Betriff "Table Scan".​</aside>
</section>

<section>
	<h3>Collection-Scan auf BSON</h3>
	<pre><code class="javascript">db.personen.find({"name":"Ulrike"})</code></pre>
	<p style="font-size:6mm; margin-left: 4cm;"><code>{"_id":1,&nbsp;&nbsp;"name":"Franka",&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"geboren":2000 }​</code></p>
	<div style="font-size: 66%;">
	<div class="sl-block" data-block-type="text" data-name="text-c65dc4" data-block-id="3fa6c8795c3c128c9d848ddfcdf58b63" style="height: auto; width: 65px; left: 22.5px; top: 189px;">
    <div class="sl-block-content" data-placeholder-tag="p" data-placeholder-text="Text" style="z-index: 10; border-style: solid; border-width: 1px; background-color: rgb(68, 170, 171); font-size: 75%;">
        <p style="text-align: center;">Länge<br>
            44</p>
    </div>
</div>
<div class="sl-block" data-block-type="text" style="height: auto; width: 65px; left: 89px; top: 189px;" data-block-id="9290905691e8d2052c5be77bd4d1ee91" data-name="text-fe8a3f">
    <div class="sl-block-content" data-placeholder-tag="p" data-placeholder-text="Text" style="z-index: 11; border-style: solid; border-width: 1px; background-color: rgb(68, 170, 171); font-size: 75%;">
			<p style="text-align: center;">Typ<br>
            16</p>
    </div>
</div>
<div class="sl-block" data-block-type="text" style="height: auto; width: 65px; left: 160px; top: 189px;" data-block-id="8f5bc46bc2ae3ce2f937d6f31dfef12d" data-name="text-6c3227">
    <div class="sl-block-content" data-placeholder-tag="p" data-placeholder-text="Text" style="z-index: 12; border-style: solid; border-width: 1px; background-color: rgb(68, 170, 171); font-size: 75%;">
			<p style="text-align: center;">Feld<br>
            _id\0</p>
    </div>
</div>
<div class="sl-block" data-block-type="text" style="height: auto; width: 65px; left: 226.5px; top: 189px;" data-block-id="f58f702340be57c189d73c5367ff9053" data-name="text-dd226d">
    <div class="sl-block-content" data-placeholder-tag="p" data-placeholder-text="Text" style="z-index: 13; border-style: solid; border-width: 1px; background-color: rgb(68, 170, 171); font-size: 75%;">
			<p style="text-align: center;">Wert<br>
            1</p>
    </div>
</div>
<div class="sl-block" data-block-type="text" style="height: auto; width: 65px; left: 298.5px; top: 189px;" data-block-id="7e249e1a6501f76ea1c3100df15b0693" data-name="text-7bbf24">
    <div class="sl-block-content" data-placeholder-tag="p" data-placeholder-text="Text" style="z-index: 14; border-style: solid; border-width: 1px; background-color: rgb(68, 170, 171); font-size: 75%;">
			<p style="text-align: center;">Typ<br>
            2</p>
    </div>
</div>
<div class="sl-block" data-block-type="text" style="height: auto; width: 87px; left: 365px; top: 189px;" data-block-id="353c1e0069f164750964dba747ac53f4" data-name="text-1ccc10">
    <div class="sl-block-content" data-placeholder-tag="p" data-placeholder-text="Text" style="z-index: 15; border-style: solid; border-width: 1px; background-color: rgb(68, 170, 171); font-size: 75%;">
			<p style="text-align: center;">Feld<br>
            name\0</p>
    </div>
</div>
<div class="sl-block" data-block-type="text" style="height: auto; width: 65px; left: 455px; top: 189px;" data-block-id="3e87c6e1fefb6a0b2f1c2540f2d40bb8" data-name="text-37e781">
    <div class="sl-block-content" data-placeholder-tag="p" data-placeholder-text="Text" style="z-index: 16; border-style: solid; border-width: 1px; background-color: rgb(68, 170, 171); font-size: 75%;">
			<p style="text-align: center;">Länge<br>
            7</p>
    </div>
</div>
<div class="sl-block" data-block-type="text" style="height: auto; width: 96px; left: 526.5px; top: 189px;" data-block-id="e857e2ba9642a7e2195580e53277b441" data-name="text-b1d49a">
    <div class="sl-block-content" data-placeholder-tag="p" data-placeholder-text="Text" style="z-index: 17; border-style: solid; border-width: 1px; background-color: rgb(68, 170, 171); font-size: 75%;">
			<p style="text-align: center;">Wert<br>
            Franka\0</p>
    </div>
</div>
<div class="sl-block" data-block-type="text" style="height: auto; width: 65px; left: 629px; top: 189px;" data-block-id="e4269b7295523fbabc69b0223685a15b" data-name="text-f55b72">
    <div class="sl-block-content" data-placeholder-tag="p" data-placeholder-text="Text" style="z-index: 18; border-style: solid; border-width: 1px; background-color: rgb(68, 170, 171); font-size: 75%;">
			<p style="text-align: center;">Typ<br>
            16</p>
    </div>
</div>
<div class="sl-block" data-block-type="text" style="height: auto; width: 117px; left: 702.5px; top: 189px;" data-block-id="a2483a2fe1eead7585fde987a9944d66" data-name="text-900feb">
    <div class="sl-block-content" data-placeholder-tag="p" data-placeholder-text="Text" style="z-index: 19; border-style: solid; border-width: 1px; background-color: rgb(68, 170, 171); font-size: 75%;">
			<p style="text-align: center;">Feld<br>
            geboren\0</p>
    </div>
</div>
<div class="sl-block" data-block-type="text" style="height: auto; width: 65px; left: 830.5px; top: 189px;" data-block-id="ef29667121bb0a31185a5a143ee65270" data-name="text-7ed51e">
    <div class="sl-block-content" data-placeholder-tag="p" data-placeholder-text="Text" style="z-index: 20; border-style: solid; border-width: 1px; background-color: rgb(68, 170, 171); font-size: 75%;">
			<p style="text-align: center;">Wert<br>
            2000</p>
    </div>
</div>
<div class="sl-block" data-block-type="text" style="height: auto; width: 54px; left: 898.5px; top: 189px;" data-block-id="c802bf809debf4f9e5cfef5b61dcb502" data-name="text-0741a4">
    <div class="sl-block-content" data-placeholder-tag="p" data-placeholder-text="Text" style="z-index: 21; border-style: solid; border-width: 1px; background-color: rgb(68, 170, 171); font-size: 75%;">
			<p style="text-align: center;">EOD<br>
            \0</p>
    </div>
</div>
<div class="sl-block" data-block-type="text" data-name="text-cc46a9" data-block-id="68c94b70d66c3616d80fc37b9d77d4e3" style="height: auto; width: 945px; left: 7.5px; top: 239.5px;">
    <div class="sl-block-content" data-placeholder-tag="p" data-placeholder-text="Text" style="z-index: 22;">
        <p style="text-align:left"><span style="font-size:1em">Bytes: 4&nbsp; &nbsp; 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 7&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4&nbsp; &nbsp; &nbsp; &nbsp; 1</span></p>
    </div>
</div>
<div class="sl-block fragment" data-fragment-index="1" data-block-type="text" data-name="text-7ff257" data-block-id="233c01afcdade6a7f11a759660b2e450" style="height: auto; width: 163px; left: 22.5px; top: 383.5px;">
    <div class="sl-block-style" style="z-index: 23; transform: rotate(0deg);">
        <div class="sl-block-content" data-placeholder-tag="p" data-placeholder-text="Text" style="z-index: 23; font-size: 75%; background-color: rgb(238, 238, 238);">
            <p>Soso, das erste Attribut ist also eine Zahl. Zahlen vom Typ 16 haben Länge 4 Byte​.</p>
        </div>
    </div>
</div>
<div class="sl-block fragment" data-fragment-index="2" data-block-type="text" style="height: auto; width: 163px; left: 192.5px; top: 383.5px;" data-block-id="1bf0a66a168304ce9dc1177405b14dcd" data-name="text-e1472a">
    <div class="sl-block-style" style="z-index: 24; transform: rotate(0deg);">
        <div class="sl-block-content" data-placeholder-tag="p" data-placeholder-text="Text" style="z-index: 24; font-size: 75%; background-color: rgb(238, 238, 238);">
            <p>Das Attribut heißt _id? Interessiert mich nicht. Ich springe drüber. Ich springe 4 Byte nach rechts.​</p>
        </div>
    </div>
</div>
<div class="sl-block fragment" data-fragment-index="3" data-block-type="text" style="height: auto; width: 135px; left: 363.5px; top: 383.5px;" data-block-id="52bbf8f0f93d253c2cdb57503a4ddaa6" data-name="text-4d603a">
    <div class="sl-block-style" style="z-index: 25; transform: rotate(0deg);">
        <div class="sl-block-content" data-placeholder-tag="p" data-placeholder-text="Text" style="z-index: 25; font-size: 75%; background-color: rgb(238, 238, 238);">
            <p>Hier springe ich hin. Das nächste Attribut ist also ein String variabler ​Länge.​</p>
        </div>
    </div>
</div>
<div class="sl-block fragment" data-fragment-index="4" data-block-type="text" style="height: auto; width: 139px; left: 507.5px; top: 383.5px;" data-block-id="86ffd316b10583c38f7a9931654a6996" data-name="text-e9df0c">
    <div class="sl-block-style" style="z-index: 26; transform: rotate(0deg);">
        <div class="sl-block-content" data-placeholder-tag="p" data-placeholder-text="Text" style="z-index: 26; font-size: 75%; background-color: rgb(238, 238, 238);">
            <p>Juhu, es heißt "name".​</p>
        </div>
    </div>
</div>
<div class="sl-block fragment" data-fragment-index="5" data-block-type="text" style="height: auto; width: 130px; left: 655px; top: 383.5px;" data-block-id="332e9983ffb917c9423cadfc77fa8959" data-name="text-fe48d0">
    <div class="sl-block-style" style="z-index: 27; transform: rotate(0deg);">
        <div class="sl-block-content" data-placeholder-tag="p" data-placeholder-text="Text" style="z-index: 27; font-size: 75%; background-color: rgb(238, 238, 238);">
            <p>Jetzt lese ich 7 Zeichen. Schade, nicht "Ulrike" sondern "Franka"​.</p>
        </div>
    </div>
</div>
<div class="sl-block fragment" data-fragment-index="6" data-block-type="text" style="height: auto; width: 146px; left: 800px; top: 383.5px;" data-block-id="34ccab5d4aa2192a7871a3bf3bfb9040" data-name="text-0fc34c">
    <div class="sl-block-style" style="z-index: 28; transform: rotate(0deg);">
        <div class="sl-block-content" data-placeholder-tag="p" data-placeholder-text="Text" style="z-index: 28; font-size: 75%; background-color: rgb(238, 238, 238);">
            <p>Den Rest des Dokuments (44-30=14 Bytes) kann ich überspringen.​</p>
        </div>
    </div>
</div>
<div class="sl-block fragment" data-fragment-index="1" data-block-type="line" data-name="line-0e260e" data-block-id="557dc9a586cfb9a307c9fb422cf1601d" style="width: auto; height: auto; min-width: 0px; min-height: 0px; left: 111px; top: 293px;">
    <div class="sl-block-content" data-line-x1="0" data-line-y1="90.5" data-line-x2="10.5" data-line-y2="0" data-line-color="#000000" data-line-start-type="none" data-line-end-type="line-arrow" style="z-index: 29;" data-line-width="5px"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" preserveAspectRatio="xMidYMid" width="10.5" height="90.5" viewBox="0 0 10.5 90.5">
            <line stroke="rgba(0,0,0,0)" stroke-width="15" x1="0.5" y1="91" x2="10.567816243677575" y2="4.225012375921862"></line>
            <line class="line-element" stroke="#000000" stroke-width="5" x1="0.5" y1="91" x2="10.567816243677575" y2="4.225012375921862"></line>
            <path style="fill: rgba(0,0,0,0);" stroke="#000000" stroke-width="5" transform="translate(10.067816243677575,3.725012375921862) rotate(6.618)" d="M 11.25 11.25 L 0 0 L -11.25 11.25"></path>
        </svg></div>
</div>
<div class="sl-block fragment" data-fragment-index="2" data-block-type="line" style="width: auto; height: auto; min-width: 0px; min-height: 0px; left: 192.5px; top: 284px;" data-block-id="39447de5018f1aa59575a02f07e7fca2" data-name="line-c61f9e">
    <div class="sl-block-content" data-line-x1="81.5" data-line-y1="99.5" data-line-x2="0" data-line-y2="0" data-line-color="#000000" data-line-start-type="none" data-line-end-type="line-arrow" style="z-index: 30;" data-line-width="5px"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" preserveAspectRatio="xMidYMid" width="81.5" height="99.5" viewBox="0 0 81.5 99.5">
            <line stroke="rgba(0,0,0,0)" stroke-width="15" x1="82" y1="100" x2="2.876229071188375" y2="3.4010403997943963"></line>
            <line class="line-element" stroke="#000000" stroke-width="5" x1="82" y1="100" x2="2.876229071188375" y2="3.4010403997943963"></line>
            <path style="fill: rgba(0,0,0,0);" stroke="#000000" stroke-width="5" transform="translate(2.376229071188375,2.9010403997943963) rotate(-39.321)" d="M 11.25 11.25 L 0 0 L -11.25 11.25"></path>
        </svg></div>
</div>
<div class="sl-block fragment" data-fragment-index="3" data-block-type="line" style="width: auto; height: auto; min-width: 0px; min-height: 0px; left: 350px; top: 278.5px;" data-block-id="e703314ead7d287fe72f577aaa8b2e63" data-name="line-944e89">
    <div class="sl-block-content" data-line-x1="81.5" data-line-y1="99.5" data-line-x2="0" data-line-y2="0" data-line-color="#000000" data-line-start-type="none" data-line-end-type="line-arrow" style="z-index: 31;" data-line-width="5px"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" preserveAspectRatio="xMidYMid" width="81.5" height="99.5" viewBox="0 0 81.5 99.5">
            <line stroke="rgba(0,0,0,0)" stroke-width="15" x1="82" y1="100" x2="2.876229071188375" y2="3.4010403997943963"></line>
            <line class="line-element" stroke="#000000" stroke-width="5" x1="82" y1="100" x2="2.876229071188375" y2="3.4010403997943963"></line>
            <path style="fill: rgba(0,0,0,0);" stroke="#000000" stroke-width="5" transform="translate(2.376229071188375,2.9010403997943963) rotate(-39.321)" d="M 11.25 11.25 L 0 0 L -11.25 11.25"></path>
        </svg></div>
</div>
<div class="sl-block fragment" data-fragment-index="4" data-block-type="line" style="width: auto; height: auto; min-width: 0px; min-height: 0px; left: 414px; top: 278.5px;" data-block-id="0ce90223f752c0bda32cb8ed20143e68" data-name="line-4822d6">
    <div class="sl-block-content" data-line-x1="163" data-line-y1="105" data-line-x2="0" data-line-y2="0" data-line-color="#000000" data-line-start-type="none" data-line-end-type="line-arrow" style="z-index: 32;" data-line-width="5px"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" preserveAspectRatio="xMidYMid" width="163" height="105" viewBox="0 0 163 105">
            <line stroke="rgba(0,0,0,0)" stroke-width="15" x1="163.5" y1="105.5" x2="3.6525327257801727" y2="2.530772614766369"></line>
            <line class="line-element" stroke="#000000" stroke-width="5" x1="163.5" y1="105.5" x2="3.6525327257801727" y2="2.530772614766369"></line>
            <path style="fill: rgba(0,0,0,0);" stroke="#000000" stroke-width="5" transform="translate(3.1525327257801727,2.030772614766369) rotate(-57.212)" d="M 11.25 11.25 L 0 0 L -11.25 11.25"></path>
        </svg></div>
</div>
<div class="sl-block fragment" data-fragment-index="5" data-block-type="line" style="width: auto; height: auto; min-width: 0px; min-height: 0px; left: 526.5px; top: 270.75px;" data-block-id="35c1f4da0a5031079b5bfaf345432ca0" data-name="line-bc2772">
    <div class="sl-block-content" data-line-x1="193.5" data-line-y1="107.25" data-line-x2="0" data-line-y2="0" data-line-color="#000000" data-line-start-type="none" data-line-end-type="line-arrow" style="z-index: 33;" data-line-width="5px"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" preserveAspectRatio="xMidYMid" width="193.5" height="107.25" viewBox="0 0 193.5 107.25">
            <line stroke="rgba(0,0,0,0)" stroke-width="15" x1="194" y1="107.75" x2="3.7798871588785112" y2="2.3179219524016554"></line>
            <line class="line-element" stroke="#000000" stroke-width="5" x1="194" y1="107.75" x2="3.7798871588785112" y2="2.3179219524016554"></line>
            <path style="fill: rgba(0,0,0,0);" stroke="#000000" stroke-width="5" transform="translate(3.2798871588785112,1.8179219524016554) rotate(-61.002)" d="M 11.25 11.25 L 0 0 L -11.25 11.25"></path>
        </svg></div>
</div>
<div class="sl-block fragment" data-fragment-index="6" data-block-type="line" style="width: auto; height: auto; min-width: 0px; min-height: 0px; left: 880.5px; top: 259px;" data-block-id="57e9c3a464246c3b3f5249db814bf364" data-name="line-9145ad">
    <div class="sl-block-content" data-line-x1="0" data-line-y1="119.25" data-line-x2="72" data-line-y2="0" data-line-color="#000000" data-line-start-type="none" data-line-end-type="line-arrow" style="z-index: 34;" data-line-width="5px"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" preserveAspectRatio="xMidYMid" width="72" height="119.25" viewBox="0 0 72 119.25">
            <line stroke="rgba(0,0,0,0)" stroke-width="15" x1="0.5" y1="119.75" x2="70.56174087862281" y2="3.710241669780972"></line>
            <line class="line-element" stroke="#000000" stroke-width="5" x1="0.5" y1="119.75" x2="70.56174087862281" y2="3.710241669780972"></line>
            <path style="fill: rgba(0,0,0,0);" stroke="#000000" stroke-width="5" transform="translate(70.06174087862281,3.210241669780972) rotate(31.122)" d="M 11.25 11.25 L 0 0 L -11.25 11.25"></path>
        </svg></div>
</div>
</div>
<aside class="notes">Es soll ein Collection Scan mit dem Prädikat <code>{"name":"Ulrike"}</code> durchgeführt werden. Dazu wird in jedem Dokument überprüft, ob es das Feld "name" besitzt und falls ja, ob dieses den Wert "Ulrike" hat. Mittels der Typ- und Längeninfos der Felder kann schnell zum nächsten Feld gesprungen werden, ohne den Wert zu lesen. Mit Hilfe der Dokumentgesamtlänge kann schnell zum Ende des Dokuments, also zum nächsten Dokument, gesprungen werden. ​</aside>
</section>

<section>
    <h3>Explain-Pläne in MongoDB Compass</h3>
        <img src="img/3/compass_explain.png" alt="MongoDB Compass" class="noborder stretch" style="margin-top:-5mm">
        <aside class="notes">MongoDB Compass kann Ausführungspläne und -statistiken visuell als Baum darstellen. Bei der hier gezeigten Query zeigt Compass an, dass kein Index bei der Anfrage genutzt wurde. Dies kann ein Hinweis darauf sein, dass einen Index zu erstellen möglicherweise sinnvoll sein könnte.</aside>
</section>

<section>
    <h3>Indexe</h3>
    <div style="position: absolute; top: 1px; right:50px; font-size:80px"><i class="fas fa-tree green"></i></div>
    <p class="small">Ein Index auf einem Feld beschleunigt Suchen und verhindert Collection-Scans.</p>
    <h4>Index auf dem <code>_id</code>-Feld (Standard)</h4>
    <pre><code class="javasript">db.produkte.getIndexes()</code></pre>
<p class="small"><code class="javascript">[ { "v" : 2, "key" : { "_id" : 1 }, "name" : "_id_" } ]</code></p>

<h4>Index-Scan</h4>
<pre><code class="javasript">db.produkte.explain("executionStats").find({"_id":12345})</code></pre>
<pre><code class="javasript">{
// ...
 "totalDocsExamined" : 1,
// ...
}</code></pre>
    <aside class="notes">Der Index auf dem <code>_id</code>-Feld wird automatisch erstellt und kann nicht gedroppt werden. Dieser Index dient nicht nur der schnellen Suche auf dem <code>_id</code>-Feld, es ist auch ein Unique-Index, der dafür sorgt, dass <code>_id</code>-Werte eindeutig sind. Der Anfrageplan mit Ausführungsstatistiken auf dieser Folie zeigt, dass nur ein Dokument angeschaut werden musste, um das gesuchte Dokument mit der <code>_id</code> 12345 zu finden.</aside>
</section>

<section>
    <h3>Index anlegen</h3>
    <pre style="width: 99%;"><code class="javascript">db.produkte.createIndex({"preis":1})</code></pre>

    <pre style="width: 99%;"><code class="javascript">// Kann genutzt werden z. B. bei:
db.produkte.find({"preis": { "$lt": NumberDecimal("1") }})
db.produkte.find().sort({"preis":-1})</code></pre>

<div class="fragment">
    <h4>Mehrdimensionale Indexe</h4>
    <pre style="width: 99%;"><code class="javascript">db.produkte.createIndex({"hersteller":1, "preis":1})</code></pre>

    <pre style="width: 99%;"><code class="javascript">// Kann genutzt werden z. B. bei:
db.produkte.find({"hersteller": "Monsterfood"});
db.produkte.find().sort({"hersteller":1});
db.produkte.find({"hersteller": "Monsterfood",
                  "preis": { "$lt": NumberDecimal("1") }});
db.produkte.find({"hersteller": "Monsterfood"}).sort({"preis":-1});</code></pre>
</div>

    <aside class="notes">Die <code>collection.createIndex</code>-Methode nimmt einen Parameter entgegen, wie man ihn von <code>sort()</code> kennt: Feldnamen und die Richtung (1: aufsteigend, -1: absteigend). Die hier gezeigten Indexe können bei Filter- und Sortieranfragen auf den angegebenen Feldern genutzt werden. Im Anfrageplan zu diesen Anfragen findet man den Schritt <code>IXSCAN</code>.</aside>
</section>

<section>
    <h3>Covered Query</h3>
    <p class="small">Kann rein mit dem Index beantwortet werden, ohne in die Collection zu schauen.</p>
    <p class="small">Dazu müssen alle Felder in der Selektion und Projektion Teil eines Indexes sein.</p>

    <pre><code class="javascript">db.produkte.createIndex({"hersteller":1, "preis":1})</code></pre>
    <pre><code class="javascript">db.produkte.find({"hersteller": "Monsterfood",
        "preis": { "$lt": NumberDecimal("1") }},
        {"preis": 1, "_id":0});</code></pre>

    <p class="small">Im Anfrageplan:<br><code>"stage" : "PROJECTION_COVERED"</code></p>
</section>

<section>
    <h3>Index-Nutzung bei der Präfix-Suche</h3>
    <pre><code class="javascript">// Produkte, deren Hersteller mit M beginnen:
db.produkte.find({"hersteller": {$regex: /^M/}})</code></pre>

    <pre class="fragment"><code class="javascript" style="max-height: 40cm;">"winningPlan" : {
        "stage" : "FETCH",
        "inputStage" : {
                "stage" : "IXSCAN",
                "indexName" : "hersteller_1_preis_1",
                // ...
                "indexBounds" : {
                        "hersteller" : [
                                "[\"M\", \"N\")",
                                "[/^M/, /^M/]"
                        ],
                        "preis" : [
                                "[MinKey, MaxKey]"
                        ]
                }
        }
}, //...
</code></pre>
<aside class="notes">Die Präfix-Suche <code>/^M/</code> wird umgewandelt in <code>&ge;M</code> und <code>&lt;N</code>.</aside>
</section>

<section>
    <h3>Collations: Textvergleiche</h3>
    <p class="small">Collections bestimmen, wie Suchen und Sortieren aufs Strings erfolgen sollen.</p>
    <pre><code class="javascript">db.produkte.createIndex({bezeichnung:1}, {collation: {
   locale:"de",
   strength: 1,
   numericOrdering: true  // "10" > "2"
} } )</code></pre>

<p class="small"><b>Strength</b>:</p>
<table class="small">
    <tr><td>1</td><td>Vergleich nur auf Base-Characters, é = è = ê = e = Ê = E</td></tr>
    <tr><td>2</td><td>Unterscheidung zwischen diakritischen Zeichen, e &lt; è, e = E, è = È</td></tr>
    <tr><td>3</td><td>Unterscheidung zwischen Groß- und Kleinschreibung, e &lt; è, e &lt; E, è &lt; È</td></tr>
</table>

<aside class="notes">Mit Collations können beispielsweise Case-insensitive Indexe erstellt werden. Im Index werden die String-Werte dann unabhängig von der Groß- und Kleinschreibung eingefügt.<br>
Ohne die Option <code>numericOrdering: true</code> würden Strings, die aus Zahlen bestehen, wie Wörter sortiert werden. <code>"2"</code> wäre also größer als <code>"10"</code>.</aside>

</section>

<section>
    <h3>Collations: Textvergleiche</h3>

<h4>Suchen</h4>
    <pre><code class="javascript">db.produkte.find(  // nutzt den Index nicht, findet nichts
 {bezeichnung:"Spulmaschinentabs"})</code></pre>

 <pre><code class="javascript">db.produkte.find(  // nutzt den Index, findet Spülmaschinentabs
 {bezeichnung:"Spulmaschinentabs"})
 .collation( { locale:"de", strength:1 } )</code></pre>

 <h4>Sortieren</h4>
 <pre><code class="javascript">db.produkte.find().collation( { locale:"de", strength:1 } )
 .sort({bezeichnung:1}).limit(5)             // nutzt den Index</code></pre>

 <h4>Default-Collation für eine Collection</h4>
    <pre><code class="javascript">db.createCollection("produkte", {collation: { ... } )</code></pre>
    <aside class="notes">Beim Suchen und Sortieren muss die Collation mit angegeben werden. Man kann aber eine Default-Collation für eine Collection festgelegen. Sie gilt dann für alle Indexe und Anfragen auf dieser Collection.</aside>
</section>

<section>
    <h3><code>text</code>-Indexe</h3>
    <div style="position: absolute; top: 1px; right:50px; font-size:80px"><i class="fas fa-spell-check green"></i></div>
    <pre style="width: 100%;"><code class="javascript">db.produkte.createIndex({ beschreibung: "text" },
                        { default_language: "de" })</code></pre>
    <div class="fragment">
    <p class="small">Es darf pro Collection höchstens einen Text-Index geben,<br>ein zusammengesetzter über mehrere Felder ist aber erlaubt:</p>
    <pre style="width: 100%;"><code class="javascript">db.produkte.createIndex({ bezeichnung: "text", beschreibung: "text" })</code></pre>
    </div>
    <div class="fragment">
    <h4>Wildcard-Text-Index (über alle String-Felder):</h4>
    <pre style="width: 100%;"><code class="javascript">db.collection.createIndex( { "$**": "text" } )</code></pre>
    </div>
    <aside class="notes">Über die Option <code>default_language</code> wird die Sprache angegeben, die für Stop-Word-Elimination und Stemming (siehe nächste Folie) verwendet wird. Wird eine weitere Option <code>"language_override": "sprache"</code> angegeben, wird die Sprache aus dem Feld <code>sprache</code> entnommen, sofern dieses im entsprechenden Dokument vorhanden ist.</aside>
</section>

<section>
    <h3><code>text</code>-Indexe</h3>
    <div style="position: absolute; top: 1px; right:50px; font-size:80px"><i class="fas fa-spell-check green"></i></div>
    <ul class="small">
        <li><em>Tokenization</em>: Strings werden in Wörter zerlegt (Case-insensitive)</li>
        <li>Sprach-spezifische <em>Stop-Word-Elimination</em></li>
        <li>Sprach-spezifisches Suffix-<em>Stemming</em> (Reduktion auf Wort-Stamm)</li>
    </ul>

    <p class="small">Beispiel: <code>{ "beschreibung": "Ein sehr gutes Produkt" }</code></p>
    <div class="columns">
        <div>
            <p class="small"><b>Tokenization</b></p>
            <p class="small"><code>"ein", "sehr",<br>"gutes", "produkt"</code></p>
        </div>
        <div>
            <p class="small"><b>Stop-Word-Elimination</b></p>
            <p class="small"><code>"gutes",<br>"produkt"</code></p>
        </div>
        <div>
            <p class="small"><b>Stemming</b></p>
            <p class="small"><code>"gut",<br>"produkt"</code></p>
        </div>
    </div>

    <aside class="notes">Wird ein Dokument mit dem hier gezeigten Text eingefügt und existiert auf dem entsprechenden Feld ein Text-Index, landen nach Tokenization, Stop-Word-Elimination und Stemming die Terms "gut" und "produkt" im Index.</aside>
</section>

<section>
    <h3><code>$text</code>-Suche</h3>
    <div style="position: absolute; top: 1px; right:50px; font-size:80px"><i class="fas fa-spell-check green"></i></div>
    <p class="small"><code>$text</code> durchsucht alle Felder, auf denen ein Text-Index definiert ist.</p>

    <pre style="width: 100%;"><code class="javascript">db.produkte.find( { $text: { $search: "die guten Sachen" } } )</code></pre>

    <pre style="width: 100%;" class="fragment"><code class="javascript" style="max-height: 99cm;">"winningPlan" : {
        "stage" : "TEXT",
        "indexPrefix" : {
        },
        "indexName" : "beschreibung_text",
        "parsedTextQuery" : {
                "terms" : [
                        "gut", 
                        "sach"
                ],
                "negatedTerms" : [ ],
                "phrases" : [ ],
                "negatedPhrases" : [ ]
        },
        "textIndexVersion" : 3,
        // ...
}</code></pre>
<aside class="notes">Auch bei den Query-Terms erfolgt Tokenization, Stop-Word-Elimination und Stemming. Die einzelnen Query-Terms werden ver-oder-t, d. h. es genügt, wenn ein Query-Term im Text vorkommt. Die hier gezeigte Anfrage würde also das Produkt mit der Beschreibung "ein sehr gutes Produkt" finden.</aside>
</section>


<section>
    <h3>Text-Score</h3>
    <div style="position: absolute; top: 1px; right:50px; font-size:80px"><i class="fas fa-spell-check green"></i></div>
    <pre style="width: 100%;"><code class="javascript">db.produkte.find( { $text: { $search: "die guten Produkte" } },
                  { score: { $meta: "textScore" } } )</code></pre>

    <p style="font-size:60%"><code class="javascript">{ "_id" : 1532, ..., "beschreibung" : "Eher schlechtes Produkt", "score" : 0.6666666666666666 }<br>
{ "_id" : 82045, ..., "beschreibung" : "Ein sehr gutes Produkt", "score" : 1.5 }</code></p>

<div class="fragment">
<h4>Sortieren nach dem Text-Score (absteigend)</h4>
<pre style="width: 100%;"><code class="javascript">db.produkte.find( { $text: { $search: "die guten Produkte" } } )
           .sort( { score: { $meta: "textScore" } } )</code></pre>
</div>

<aside class="notes">Im oberen Beispiel wurde im Projektions-Parameter ein neues Feld <code>score</code> eingeführt, in welchem der Text-Score stehen wird. In der unteren Anfrage werden die Suchergebnisse nach dem Score absteigend sortiert.</aside>
</section>

<section>
    <h3>Indexe auf Subattributen und Arrays</h3>
    <pre><code class="javascript">db.kunden.createIndex({"geboren.jahr":1})</code></pre>

    <div class="fragment">
    <h4>Multi-Key-Indexe</h4>
    <pre><code class="javascript">db.produkte.createIndex({"kategorien":1})</code></pre>
    <p class="small">Sobald es Array-Werte gibt, legt MongoDB einen Multi-Key-Index an<br>
        &Rightarrow; Ein Eintrag im Index für jedes Element im Array
        </p>
    </div>
    <aside class="notes">Der oberere Index hilft bei der Anfrage, wer 1980 geboren ist: <code>db.kunden.find({"geboren.jahr":1980})</code>, die untere beim Finden von Produkten der Kategorie Lebensmittel: <code>db.produkte.find({kategorien:"Lebensmittel"})</code></aside>
</section>

<section>
    <h3>Sparse und partielle Indexe</h3>
    <h4>Sparse Index</h4>
    <div style="position: absolute; top: 70px; right:50px; font-size:80px"><i class="fas fa-braille green"></i></div>
    <p class="small" style="margin-top: -4mm; margin-bottom: -4mm;">... indiziert nur Dokumente, bei denen es das Feld auch wirklich gibt:</p>
    <pre><code class="javascript">db.produkte.createIndex({verlag:1}, {sparse:true})</code></pre>

    <div class="fragment" style="margin-top: 14mm;">
    <h4>Partieller Index</h4>
    <div style="position: absolute; top: 260px; right:50px; font-size:80px"><i class="fas fa-pizza-slice green"></i></div>
    <p class="small" style="margin-top: -4mm; margin-bottom: -4mm;">... indiziert nur Dokumente, die ein bestimmtes Kriterium erfüllen:</p>
    <pre><code class="javascript">db.produkte.createIndex({gewicht:1}, 
          {partialFilterExpression:{kategorie:"Lebensmittel"}})</code></pre>
    </div>

    <aside class="notes">Sparse-Indexe eignen sich für Felder, die nur in wenigen Dokumenten vorhanden ist. Einfügungen, Löschungen und Änderungen an Dokumenten, in denen es das Feld nicht gibt, haben dann keine Auswirkungen auf den Index.<br>
Ähnliches gilt bei partiellen Indexen. In dem gegebenen Beispiel landen nur Dokumente im Index, die in der Kategorie Lebensmittel sind. Das spart Platz und Index-Wartungskosten. Der partielle Index hilft aber nur bei solchen Queries, in denen auch die partialFilterExpression vorkommt, in unserem Beispiel also etwa bei <code>db.produkte.find({kategorie:"Lebensmittel", "gewicht": {$gt:1000}})</code>   
    </section>

<section>
    <h3>Unique- und Hashed-Indexe</h3>
    <div style="position: absolute; top: 70px; right:50px; font-size:80px"><i class="fas fa-fingerprint green"></i></div>
    <h4>Unique-Index</h4>
    <p class="small" style="margin-top: -4mm; margin-bottom: -4mm;">... passt auf, dass jeder Wert in der Collection nur einmal vorkommt:</p>
    <pre><code class="javascript">db.kunden.createIndex({email:1}, {unique:true})</code></pre>

    <div class="fragment" style="margin-top: 14mm;">
        <div style="position: absolute; top: 240px; right:50px; font-size:80px"><i class="fas fa-hashtag green"></i></div>
    <h4>Hashed-Index</h4>
    <p class="small" style="margin-top: -4mm; margin-bottom: -4mm;">... trägt nicht die Werte sondern Ergebnisse einer Hash-Funktion in den Index ein:</p>
    <pre><code class="javascript">db.kunden.createIndex({email:"hashed"})</code></pre>

    <p class="small">$h('peter@example.com') = 1510671575292898645$</p>
    </div>

    <aside class="notes">Bei einem Unique-Index auf mehreren Feldern muss die Kombination der Werte in den angegebenen Feldern eindeutig sein: <code>db.kunden.createIndex({vorname:1, nachname:1}, {unique:true})</code>. Sind beim Erstellen eines Unique-Indexes schon mehrfach vorkommende Werte vorhanden, wird das Index-Erstellen fehlschlagen. Auf dem Feld <code>_id</code> existiert immer ein Unique-Index.<br>
    Der Nutzen eines Hashed-Index wird erst im Sharding-Kapitel erklärt. Hash-Indexe können nämlich für eine gleichmäßigere Verteilung der Dokumente auf mehrere Rechnerknoten im Cluster sorgen.<br>
    Sucht man nach einer E-Mail-Adresse x, wird h(x) berechnet und dies nun im Index nachgeschlagen. 
    </aside>
</section>

<section>
    <h3>TTL-Indexe - Time To Live</h3>
    <div style="position: absolute; top: 20px; right:50px; font-size:120px"><i class="fas fa-skull-crossbones green"></i></div>

    <p class="small">Dokument wird automatisch gelöscht, wenn<br><code>lastModifiedDate < jetzt - expireAfterSeconds</code></p>

    <pre><code class="javascript">db.warenkorb.createIndex( { "lastModifiedDate": 1 }, 
                          { expireAfterSeconds: 86400 } )</code></pre>

    <aside class="notes">TTL-Indexe können nur auf Felder vom BSON-Typ Date und auf Arrays von Dates definiert werden. Sie sorgen dafür, dass Dokumente nach einer gewissen Zeit "ablaufen" und dann automatisch aus der Collection gelöscht werden. Ist das Feld ein Array mit Dates, wird aus diesem der kleinste (früheste) Wert genommen.<br>
    TTL-Indexe sind sinnvoll, wenn man nur aktuelle Daten benötigt und keine historischen Daten behalten will, z. B. Event- oder Sensor-Daten, Logs, Session-Daten, etc.</aside>
</section>

<section>
    <h3>Geodaten und Geo-Indexe</h3>
    <p class="small"><code class="javascript">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;longitude, latitude<br>
{"_id": 6, "name": "Ute", "coord": [12.095089, 49.003674]}</code></p>

    <pre><code class="javascript">db.kunden.createIndex( { coord: "2dsphere" } )</code></pre>

<div class="fragment">
    <h4>GeoJSON</h4>
    <p class="small">GeoJSON-Objekt-Typen: <code>Point</code>, <code>LineString</code>, <code>Polygon</code>, ...</p>
    <span style="font-size: 2cm; position: absolute; top: 6cm; right: 4cm;" class="red">.</span>
    
    <div class="sl-block" data-block-type="line" data-name="line-f7a33c" data-block-id="0358d6fa866ae4e4793c4b634184ef0c" style="width: auto; height: auto; min-width: 0px; min-height: 0px; left: 799px; top: 360px;">
        <div class="sl-block-content" data-line-x1="0" data-line-y1="0" data-line-x2="80" data-line-y2="0" data-line-color="#000000" data-line-start-type="none" data-line-end-type="none" style="z-index: 10;" data-line-width="4px"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" preserveAspectRatio="xMidYMid" width="80" height="1" viewBox="0 0 80 1">
                        <line stroke="rgba(0,0,0,0)" stroke-width="15" x1="0" y1="0" x2="80" y2="0"></line>
                        <line class="line-element" stroke="#ff6363" stroke-width="4" x1="0" y1="0" x2="80" y2="0"></line>
                </svg></div>
</div>
<div class="sl-block" data-block-type="line" style="width: auto; height: auto; min-width: 0px; min-height: 0px; left: 800px; top: 360px;" data-block-id="cb69b9127a25f3059c892f8db107bc40" data-name="line-40d799">
        <div class="sl-block-content" data-line-x1="20" data-line-y1="70" data-line-x2="80" data-line-y2="0" data-line-color="#000000" data-line-start-type="none" data-line-end-type="none" style="z-index: 11;" data-line-width="4px"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" preserveAspectRatio="xMidYMid" width="80" height="70" viewBox="0 0 80 70">
                        <line stroke="rgba(0,0,0,0)" stroke-width="15" x1="20" y1="70" x2="80" y2="0"></line>
                        <line class="line-element" stroke="#ff6363" stroke-width="4" x1="20" y1="70" x2="80" y2="0"></line>
                </svg></div>
</div>
<div class="sl-block" data-block-type="line" style="width: auto; height: auto; min-width: 0px; min-height: 0px; left: 799px; top: 360px;" data-block-id="ce9846899e64939cbe9394efef95c4cd" data-name="line-5bcb67">
        <div class="sl-block-content" data-line-x1="0" data-line-y1="30" data-line-x2="0" data-line-y2="0" data-line-color="#000000" data-line-start-type="none" data-line-end-type="none" style="z-index: 12;" data-line-width="4px"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" preserveAspectRatio="xMidYMid" width="1" height="70" viewBox="0 0 1 70">
                        <line stroke="rgba(0,0,0,0)" stroke-width="15" x1="0" y1="30" x2="0" y2="0"></line>
                        <line class="line-element" stroke="#ff6363" stroke-width="4" x1="0" y1="30" x2="0" y2="0"></line>
                </svg></div>
            </div>

<!-- Polygon -->
    <div class="sl-block" data-block-type="shape" data-name="shape-10bafd" data-block-id="93531f61e7410a9f5650a6138d0a7bbb" style="width: 160px; height: 140px; left: 740px; top: 450px;">
    <div class="sl-block-content" data-shape-type="diamond" data-shape-fill-color="#ff6363" data-shape-stretch="true" style="z-index: 10;"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="100%" height="100%" preserveAspectRatio="none" viewBox="0 0 160 140">
                    <polygon points="160,70 80,140 0,70 80,0" class="shape-element" fill="#ff6363"></polygon>
            </svg></div></div>

    <p class="small"><code class="javascript">{<br>
&nbsp;_id: 5, name: "Peter", coord: {<br>
&nbsp;&nbsp;type: "Point",<br>
&nbsp;&nbsp;coordinates: [12.11595, 49.026222]<br>
&nbsp;}<br>
}</code></p>
</div>

    <aside class="notes">Der simpelste Weg, Geo-Koordinaten in MongoDB zu speichern ist ein Array mit zwei Elementen: dem Längengrad (zwischen -180 und 180) und Breitengrad (zwischen -90 und 90). Alternativ kann GeoJSON verwendet werden. Damit sind auch andere Objekte als nur Punkte möglich.</aside>
</section>

<section>
    <!--
create table kunden(coords GEOMETRY(POINT, 4326));

insert into kunden values (ST_GEOMFROMTEXT('POINT(12.095089 49.003674)', 4326));
insert into kunden values (ST_GEOMFROMTEXT('POINT(12.11595 49.026222)', 4326));

select coords from kunden
union select ST_GEOMFROMTEXT('POLYGON((6 55, 15 55, 15 47, 6 47, 6 55))', 4326);
    -->
    <div style="position: absolute; top: 20px; right:50px; font-size:120px"><i class="fas fa-map-marked-alt green"></i></div>
    <h3>Anfragen auf Geodaten</h3>

    <h4><code>$near</code>: Umkreissuche</h4>
    <pre><code class="javascript">db.kunden.find( { "coord": { $near : {
  $geometry: { type: "Point", coordinates: [12.0904, 48.9878]},
  $maxDistance: 2000  /* 2km */
} } } )</code></pre>

<div class="fragment">

<h4><code>$geoWithin</code></h4>
<pre style="width: 18cm; left: -2.5cm;"><code class="javascript">db.kunden.find( { "coord": { $geoWithin : {
 $geometry: { type: "Polygon", coordinates: 
   [[ [6, 55], [15, 55], [15, 47], 
      [6, 47], [6, 55] ]]},
} } } )</code></pre>
<img src="img/3/germany.png" style="position: absolute; top: 8cm; right: 1mm; width: 5.5cm;" class="noborder">
</div>
<aside class="notes">Die Suchoperatoren auf Geodaten nehmen ein GeoJSON-Objekt entgegen. Ein Punkt ist ein Array mit Längengrad, Breitengrad. Ein LineString ein Array mit solchen Punkten. Und ein Polygon ist ein Array mit einen geschlossenen Linestring, und optional weitere geschlossene Linestrings, die die Löcher im Polygon darstellen. Hier suchen wir alle Kunden im Umkreis von 2km vom Uniklinikum Regensburg sowie alle Kunden innerhalb der Bounding-Box um Deutschland. Für diese Anfragen muss ein Geoindex existieren.</aside>
</section>


<section>
    <h3>Indexe droppen oder verstecken</h3>
    <pre style="width: 100%;"><code class="javascript">db.produkte.dropIndex("gewicht_1");  // über den Index-Namen
db.produkte.dropIndex({"verlag":1}); // oder wie er spezifiziert wurde</code></pre>

<div class="fragment">
    <h4>Hidden Index</h4>
    <p class="small" style="margin-top: -4mm; margin-bottom: -4mm;">... ist zwar da, wird aber nicht bei Query-Ausführungen genutzt:</p>
    <pre style="width: 100%;"><code class="javascript">db.produkte.createIndex({"hersteller":1}, {"hidden":true})</code></pre>

    <pre style="width: 100%;"><code class="javascript">db.produkte.hideIndex({"hersteller":1})</code></pre>
    <pre style="width: 100%;"><code class="javascript">db.produkte.unhideIndex({"hersteller":1})</code></pre>
</div>
<aside class="notes">Indexe beschleunigen Anfragen, verlangsamen aber Einfügungen, Löschungen und Änderungen. Daher sollte das Anlegen von Indexen gut durchdacht und evaluiert werden. Anders als bei <code>dropIndex</code> wird beim Verstecken eines Indexes der Index nicht entfernt, sondern lediglich für seine Nutzung deaktiviert. Er wird weiterhin gepflegt und belegt Platz. Das ist für Performance-Experimente nützlich, um Indexe nicht jedes mal komplett neu erstellen zu müssen.</aside>
</section>

<section>
    <h3>Indexe in MongoDB Compass</h3>
        <img src="img/3/compass_index.png" alt="MongoDB Compass" class="noborder stretch" style="margin-top:-5mm">
        <aside class="notes">Ähnlich zu <code>collection.getIndexes()</code> listet auch MongoDB Compass alle auf einer Collection befindlichen Indexe auf. Zusätzlich werden zu jedem Index Statistiken angezeigt wie deren Größe und die Anzahl der Verwendungen und das Datum der letzten Nutzung. Indexe, die nur selten genutzt werden, sollen man evtl. besser droppen, da jeder Index die Performance von Schreiboperationen negativ beeinflusst.</aside>
</section>

<section>
    <h3>Monitoring</h3>
    <div style="position: absolute; top: 70px; right:50px; font-size:120px"><i class="fas fa-user-md green"></i></div>
    <h4><code>mongostat</code></h4>
    <p class="small">Überblick über den Status der MongoDB-Instanz</p>
    <pre><code class="plaintext">insert query update delete getmore command dirty used flushes
    *0    *0     *1     *0       0     5|0  0.4% 0.5%       0

vsize  res qrw arw net_in net_out conn                time
1.48G 148M 0|0 1|0   157b   84.2k   17 Oct 15 06:47:08.811</code></pre>

<p class="small">Im Moment ...</p>
<ul class="small">
    <li>... läuft eine Update-Query</li>
    <li>... konsumiert MongoDB 148 MB RAM</li>
    <li>... wartet kein Client aufs Lesen (<code>qr</code>) oder Schreiben (<code>qw</code>)</li>
    <li>... ist ein Client aktiv beim Lesen (<code>ar</code>), keiner beim Schreiben (<code>aw</code>)</li>
    <li>... sind 17 Clients verbunden</li>
</ul>

</section>

<section>
    <h3>Monitoring</h3>
    <h4><code>mongotop [n]</code></h4>
    <div style="position: absolute; top: 20px; right:50px; font-size:120px"><i class="fas fa-stopwatch green"></i></div>
    <p class="small">Wie lange hat MongoDB in den letzten n Sekunden mit Lesen/Schreiben verbracht?</p>
    <p class="small">Standardmäßig n = 1 (jede Sekunde)</p>
    <pre><code>                    ns    total    read    write
        webshop.produkte    900ms     0ms    900ms
      admin.system.roles      0ms     0ms      0ms
    admin.system.version      0ms     0ms      0ms
      config.collections      0ms     0ms      0ms
  config.system.sessions      0ms     0ms      0ms
     config.transactions      0ms     0ms      0ms
    local.system.replset      0ms     0ms      0ms</code></pre>

    <aside class="notes">Das Konsolenprogramm <code>mongotop</code> (Teil der MongoDB Database Tools) zeigt jede Sekunde an, wie viel aktuell auf den einzelnen Collections los ist. Im gezeigten Beispiel wurde in der vergangenen Sekunde 900ms lang, also fast die ganze Zeit, in die <code>produkte</code>-Collection geschrieben.</aside>
</section>

<section>
    <h3>Monitoring</h3>
    <div class="columns">
        <div>
            <h4><code>db.currentOp()</code></h4>
            <p class="small" style="margin-top: -4mm; margin-bottom: 0mm;">Zeigt aktuell laufende Operationen an.</p>
        </div>
        <div class="fragment">
            <h4><code>db.killOp(32324)</code></h4>
            <p class="small" style="margin-top: -4mm; margin-bottom: 0mm;">Killt eine laufende Operation.</p>
        </div>
    </div>
    
    <pre><code style="max-height: 40cm;" class="json">{
 "inprog" : [
   {
        "type" : "op",
        "host" : "jotebook:27017",
        // ...
        "opid" : 32324,
        "op" : "update",
        "ns" : "webshop.produkte",
        "command" : {
                "q" : {

                },
                "u" : {
                        "$inc" : {
                                "preis" : 0.1
//...</code></pre>
<aside class="notes">Ein Client führt gerade eine Update-Query aus, die den Preis jedes Produkts um 10ct erhöht.</aside>
</section>

<section>
    <h3>Profiling</h3>
    <p class="small">Sammelt Infos über ausgeführte Queries in der Collection <code>system.profile</code></p>

    <h4 style="margin-top: -2mm; margin-bottom: 2mm;">Profiling-Levels</h4>
    <table class="small">
        <tr><th>0</th><td>Profiling ist ausgeschaltet (Standard)</td></tr>
        <tr><th>1</th><td>Der Profiler sammelt Daten über Operationen,<br>die länger als <code>slowms</code> Millisekunden dauern</td></tr>
        <tr><th>2</th><td>Der Profiler sammelt Daten über alle Operationen</td></tr>
    </table>

    <pre><code class="bash">$ mongod --profile 1 --slowms 30</code></pre>
    <pre><code>> db.setProfilingLevel(2)
> db.setProfilingLevel(1, { slowms: 30 })
> db.getProfilingStatus()
{ "was" : 1, "slowms" : 30, "sampleRate" : 1 }
</code></pre>
<aside class="notes">Profiling kann beim Start von <code>mongod</code> eingeschaltet werden oder nachträglich über Mongo-Shell-Kommandos. Man sieht im Profile, welche Anfragen die Anwendungen an die Datenbank schicken. Außerdem kann man damit herausfinden, welche Anfragen seit dem Aktivieren von Profiling besonders lange liefen. Das kann Hinweise darüber geben, welche Indexe man anlegen könnte.</aside>
</section>

<section>
    <h3>Profiling</h3>
    <pre><code class="javascript">db.system.profile.find().pretty()</code></pre>
    <pre><code class="json" style="max-height: 99cm;">{​
    "op" : "query",​
    "ns" : "webshop.produkte",​
    "command" : {
        "find" : "produkte",
        "filter" : {
            "preis" : {
                    "$lt" : 1
            }
        }
    },
    // ...
    "docsExamined" : 100000,​
    // ...
    "nreturned" : 69,​
    "responseLength" : 9782,​
    "millis" : 98,​
    "execStats" : { ... },​
    "ts" : ISODate("2021-10-15T05:29:14.378Z")​
}​</code></pre>
<aside class="notes">Im Profile ist zu sehen, dass eine Anfrage lief, die Produkte sucht, die weniger als 1 EUR kosten. Sie dauerte 98ms. Ein Index auf dem <code>preis</code>-Feld könnte solche Queries in Zukunft beschleunigen.</aside>
</section>

<section>
    <h3>Capped Collections</h3>
    <div style="position: absolute; top: 70px; right:50px; font-size:130px"><i class="fas fa-recycle green"></i></div>
    <ul class="small">
        <li>Collection mit angegebener Maximalgröße</li>
        <li>Ermöglicht schnelle Einfügungen</li>
        <li>Voll? Ältestes Dokument wird gelöscht.</li>
    </ul>
    <pre><code class="javascript">db.createCollection("Wetterdaten", 
                    { capped:true, size:1024*1024} })</code></pre>

    <p class="small"><code>db.system.profile</code> ist eine Capped Collection.</p>

    <aside class="notes">Eine Capped Collection (capped: gedeckelt) ist eine Collection, die eine gegebene Maximalgröße nicht überschreitet (hier: 1 MB). Würde bei einer Einfügeoperation die Collection überlaufen, wird das älteste Dokument gelöscht. </aside>
</section>

<section>
    <h3>WiredTiger (Storage-Engine)</h3>
    <h4>Document-Level-Concurrency</h4>
    <p class="small" style="margin-top: -3mm;">Clients können gleichzeitig verschiedene Dokumenten modifizieren.<br>Seit MongoDB 4 werden aber auch Multi-Document-Transactions​ unterstützt.</p>

    <h4>Journaling</h4>
    <p class="small" style="margin-top: -3mm;">Änderungen ins Journal-Log schreiben, um Dauerhaftigkeit zu gewährleisten.</p>

    <h4>Kompression</h4>
    <p class="small" style="margin-top: -3mm;">WiredTiger nutzt Kompression, sodass mehr Daten in den RAM passen.<br>
    <ul class="small">
        <li><code>snappy</code> (Standard-Kompressionslibrary): schnell</li>
        <li><code>lzip</code>: höherer Kompressionsgrad</li>
        <li><code>zstd</code>: noch höherer Kompressionsgrad</li>
        <li><code>none</code></li>
    </ul>

    <aside class="notes">Eine Storage-Engine legt fest, wie die DB-Daten auf der Festplatte gespeichert werden. MongoDB verwendet seit Version 3.2 standardmäßig WiredTiger. Will ein Client ein Dokument verändern, sperrt es dies mit einer X-Sperre, sodass kein anderer Client es gleichzeitig ändern kann.</aside>
</section>

<section>
    <h3>In-Memory-Storage-Engine</h3>
    <pre><code class="bash">$ mongod --storageEngine inMemory</code></pre>
    <ul class="small">
        <li>Nur verfügbar in MongoDB Enterprise</li>
        <li>Datenbank (Collections, Indexe, ...) muss in den RAM passen</li>
        <li>Kein Journaling</li>
        <li>Beim Shutdown oder Crash sind alle Daten weg</li>
        <li>Sinnvoll bei Replikation: z. B. 1 Knoten WiredTiger + 2 Knoten InMemory</li>
    </ul>
    
</section>


<section>
    <h3>Zusammenfassung</h3>
    <ul class="small">
        <li>Anfragepläne: <code>explain()</code>, <code>explain("executionStats")</code></li>
        <li>Collection-Scan vs. Index-Scan</li>
        <li>Indexe: Mehrdimensional, Multi-Key-Index, <code>$text</code>, sparse, partielle Indexe, Unique, Hashed, Hidden, TTL, Geo-Index</li>
        <li>Collations</li>
        <li>Monitoring: <code>mongostat</code>, <code>mongotop</code>, <code>db.currentOp()</code>, <code>db.killOp</code></li>
        <li>Profiling</li>
        <li>Storage-Engines: WiredTiger, In-Memory</li>

    </ul>
</section>


			</div>
		</div>

		<script src="reveal.js/dist/reveal.js"></script>
		<script src="reveal.js/plugin/markdown/markdown.js"></script>
		<script src="reveal.js/plugin/highlight/highlight.js"></script>
		<script src="reveal.js/plugin/zoom/zoom.js"></script>
		<script src="reveal.js/plugin/math/math.js"></script>
		<script src="reveal.js/plugin/notes/notes.js"></script>
		<script src="reveal.js/plugin/search/search.js"></script>
        <script src="lib/jquery.js"></script>
        <script src="lib/lodash.js"></script>
        <script src="lib/backbone.js"></script>
        <script src="lib/joint.min.js"></script>
				<script src="lib/deflate.js"></script>

		<script src="src/init_reveal.js"></script>

        <script>
        if(window.location.search.match( /print-pdf/gi )) {
                document.getElementById('header').style="display:none";
                document.getElementById('footer').style="display:none";
        }
        </script>


	</body>
</html>
